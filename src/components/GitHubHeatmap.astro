---
import type { ContributionsIndex } from "../types";

interface Props {
  contributions: ContributionsIndex | null;
}

const { contributions } = Astro.props;

// Grayscale color palette matching the site's black & white aesthetic
// Light mode: light gray (low) to dark (high)
// Dark mode: dark gray (low) to light (high)
const levelColorsLight: Record<0 | 1 | 2 | 3 | 4, string> = {
  0: "#e5e5e5", // neutral-200
  1: "#a3a3a3", // neutral-400
  2: "#737373", // neutral-500
  3: "#404040", // neutral-700
  4: "#0a0a0a", // neutral-950
};

const levelColorsDark: Record<0 | 1 | 2 | 3 | 4, string> = {
  0: "#262626", // neutral-800
  1: "#525252", // neutral-600
  2: "#737373", // neutral-500
  3: "#a3a3a3", // neutral-400
  4: "#ffffff", // white
};

// SVG dimensions
const cellSize = 12;
const cellGap = 3;
const cellRadius = 2;
const weekCount = 53;
const dayCount = 7;
const leftPadding = 32; // Space for day labels
const topPadding = 20; // Space for month labels
const width = leftPadding + weekCount * (cellSize + cellGap);
const height = topPadding + dayCount * (cellSize + cellGap);

// Day labels
const dayLabels = ["", "Mon", "", "Wed", "", "Fri", ""];

// Helper to get month labels positions
function getMonthLabels(days: { date: string }[]): { label: string; x: number }[] {
  const months: { label: string; x: number }[] = [];
  let currentMonth = "";

  days.forEach((day, index) => {
    const date = new Date(day.date);
    const month = date.toLocaleString("en-US", { month: "short" });
    const weekIndex = Math.floor(index / 7);

    if (month !== currentMonth) {
      currentMonth = month;
      months.push({
        label: month,
        x: leftPadding + weekIndex * (cellSize + cellGap),
      });
    }
  });

  return months;
}

// Organize contributions into weeks (columns) for the heatmap
function organizeIntoWeeks(
  contributions: { date: string; count: number; level: 0 | 1 | 2 | 3 | 4 }[]
): { date: string; count: number; level: 0 | 1 | 2 | 3 | 4; dayOfWeek: number }[][] {
  const weeks: { date: string; count: number; level: 0 | 1 | 2 | 3 | 4; dayOfWeek: number }[][] = [];
  let currentWeek: { date: string; count: number; level: 0 | 1 | 2 | 3 | 4; dayOfWeek: number }[] = [];

  contributions.forEach((day) => {
    const date = new Date(day.date);
    const dayOfWeek = date.getDay(); // 0 = Sunday

    if (dayOfWeek === 0 && currentWeek.length > 0) {
      weeks.push(currentWeek);
      currentWeek = [];
    }

    currentWeek.push({ ...day, dayOfWeek });
  });

  if (currentWeek.length > 0) {
    weeks.push(currentWeek);
  }

  return weeks;
}

const weeks = contributions ? organizeIntoWeeks(contributions.contributions) : [];
const monthLabels = contributions ? getMonthLabels(contributions.contributions) : [];
---

{
  contributions ? (
    <div class="overflow-x-auto">
      <div class="min-w-fit">
        {/* Light mode heatmap */}
        <svg
          viewBox={`0 0 ${width} ${height}`}
          class="w-full max-w-4xl dark:hidden"
          role="img"
          aria-label={`GitHub contribution graph showing ${contributions.totalContributions} contributions in the last year`}
        >
          {/* Month labels */}
          {monthLabels.map((month) => (
            <text
              x={month.x}
              y={12}
              class="fill-neutral-500 text-[10px]"
              font-size="10"
            >
              {month.label}
            </text>
          ))}

          {/* Day labels */}
          {dayLabels.map((label, index) => (
            <text
              x={0}
              y={topPadding + index * (cellSize + cellGap) + cellSize - 2}
              class="fill-neutral-500 text-[10px]"
              font-size="10"
            >
              {label}
            </text>
          ))}

          {/* Contribution cells */}
          {weeks.map((week, weekIndex) =>
            week.map((day) => (
              <rect
                x={leftPadding + weekIndex * (cellSize + cellGap)}
                y={topPadding + day.dayOfWeek * (cellSize + cellGap)}
                width={cellSize}
                height={cellSize}
                rx={cellRadius}
                ry={cellRadius}
                fill={levelColorsLight[day.level]}
                data-date={day.date}
                data-count={day.count}
              >
                <title>
                  {day.count} contribution{day.count !== 1 ? "s" : ""} on{" "}
                  {new Date(day.date).toLocaleDateString("en-US", {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                  })}
                </title>
              </rect>
            ))
          )}
        </svg>

        {/* Dark mode heatmap */}
        <svg
          viewBox={`0 0 ${width} ${height}`}
          class="hidden w-full max-w-4xl dark:block"
          role="img"
          aria-label={`GitHub contribution graph showing ${contributions.totalContributions} contributions in the last year`}
        >
          {/* Month labels */}
          {monthLabels.map((month) => (
            <text
              x={month.x}
              y={12}
              class="fill-neutral-400 text-[10px]"
              font-size="10"
            >
              {month.label}
            </text>
          ))}

          {/* Day labels */}
          {dayLabels.map((label, index) => (
            <text
              x={0}
              y={topPadding + index * (cellSize + cellGap) + cellSize - 2}
              class="fill-neutral-400 text-[10px]"
              font-size="10"
            >
              {label}
            </text>
          ))}

          {/* Contribution cells */}
          {weeks.map((week, weekIndex) =>
            week.map((day) => (
              <rect
                x={leftPadding + weekIndex * (cellSize + cellGap)}
                y={topPadding + day.dayOfWeek * (cellSize + cellGap)}
                width={cellSize}
                height={cellSize}
                rx={cellRadius}
                ry={cellRadius}
                fill={levelColorsDark[day.level]}
                data-date={day.date}
                data-count={day.count}
              >
                <title>
                  {day.count} contribution{day.count !== 1 ? "s" : ""} on{" "}
                  {new Date(day.date).toLocaleDateString("en-US", {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                  })}
                </title>
              </rect>
            ))
          )}
        </svg>

        {/* Legend - Light mode */}
        <div class="mt-4 flex items-center justify-end gap-2 text-xs text-neutral-500 dark:hidden">
          <span>Less</span>
          {([0, 1, 2, 3, 4] as const).map((level) => (
            <span
              class="inline-block h-3 w-3 rounded-sm"
              style={`background-color: ${levelColorsLight[level]}`}
            />
          ))}
          <span>More</span>
        </div>

        {/* Legend - Dark mode */}
        <div class="mt-4 hidden items-center justify-end gap-2 text-xs text-neutral-400 dark:flex">
          <span>Less</span>
          {([0, 1, 2, 3, 4] as const).map((level) => (
            <span
              class="inline-block h-3 w-3 rounded-sm"
              style={`background-color: ${levelColorsDark[level]}`}
            />
          ))}
          <span>More</span>
        </div>

        {/* Total contributions */}
        <p class="mt-4 text-sm text-neutral-600 dark:text-neutral-400">
          {contributions.totalContributions.toLocaleString()} contributions in the last year
        </p>
      </div>
    </div>
  ) : (
    <div class="rounded-3xl bg-neutral-50 p-12 text-center dark:bg-neutral-900">
      <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral-200 dark:bg-neutral-800">
        <svg
          class="h-6 w-6 text-neutral-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"
          />
        </svg>
      </div>
      <h3 class="mt-4 text-lg font-semibold text-neutral-950 dark:text-white">
        No contribution data
      </h3>
      <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
        Run{" "}
        <code class="rounded-md bg-neutral-100 px-2 py-0.5 font-mono text-xs text-neutral-700 dark:bg-neutral-800 dark:text-neutral-300">
          bun run sync:github
        </code>{" "}
        to fetch contribution data from GitHub.
      </p>
    </div>
  )
}
